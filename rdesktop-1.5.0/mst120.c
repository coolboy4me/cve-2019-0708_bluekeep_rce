#include <stdio.h>
#include <time.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <semaphore.h>
#include "rdesktop.h"

#define MST120_SEND_MAX 2
#define MST120_TIMEOUT 5  // in seconds

static VCHANNEL *mst120_channel;
static int check_count;
static int first_check;

static void
mst120_process(STREAM s)
{
    // pass
}
	

BOOL
mst120_check_init()
{
    check_count = 0;
    first_check = 0;

    mst120_channel = channel_register("MS_T120",
      CHANNEL_OPTION_INITIALIZED | CHANNEL_OPTION_COMPRESS_RDP,
      mst120_process);

    return (mst120_channel != NULL);
}


void
my_rdp_send_input(uint32 time, uint16 message_type, uint16 device_flags, uint16 param1, uint16 param2)
{
        STREAM s;

        int number = 9;
        s = rdp_init_data(4 + 16 * number);

        out_uint16_le(s, number);       /* number of events */
        out_uint16(s, 0);       /* pad */

        for (int i = 0; i < number; i++)
        {
                out_uint32_le(s, time);
                out_uint16_le(s, message_type);
                out_uint16_le(s, device_flags);
                out_uint8(s, 'A');
                out_uint8(s, 'A');      //keycode
                out_uint8(s, 'A');
                out_uint8(s, 'A');      //pad2octets
        }

        s_mark_end(s);
        rdp_send_data(s, RDP_DATA_PDU_INPUT);
}

 

sem_t *psem1, *psem2;
void
mst120_send_check_packet(size_t size, size_t offset)
{
    if (check_count == 1)
    {
    int shmid1 = shmget((key_t)111, sizeof(sem_t), 0666 | IPC_CREAT);
    void *shm1 = shmat(shmid1, 0, 0);
    psem1 = (sem_t *)shm1;
    
    int shmid2 = shmget((key_t)222, sizeof(sem_t), 0666 | IPC_CREAT);
    void *shm2 = shmat(shmid2, 0, 0);
    psem2 = (sem_t *)shm2;
    
    
	    char *buff = (char*)malloc(size);

	    if (!buff)
		    return;
            memset(buff, 0, size);

            buff[offset] = 2;

            STREAM s = channel_init(mst120_channel, size);
            out_uint8p(s, buff, size);
            s_mark_end(s);
            channel_send(s, mst120_channel);
            free(buff);
			sem_post(psem1);
    }
    else 
    {
#if 0
      for (int i = 0; i < 1000; i++)
      {
        my_rdp_send_input(time(NULL), RDP_INPUT_SCANCODE, KBD_FLAG_DOWN, 0,0);
      }
      
#if 1
	    sem_post(psem1);
#endif 
#endif
    }
}

void
mst120_check()
{
    ++check_count;
    if (check_count > MST120_SEND_MAX)
    {
      sem_wait(psem2);
      sem_destroy(psem1);
      sem_destroy(psem2);
      exit(0);
    }

    //mst120_send_check_packet(0x20, 8);
    mst120_send_check_packet(0x100, 4);
}

